@if (isOpen) {
    <div (click)="close()" class="absolute inset-0 bg-black/40  flex justify-center items-center z-50">
        <div (click)="$event.stopPropagation()" class="bg-zinc-700 rounded-lg p-6 w-full max-w-2xl relative my-5">
            @if (!createCustomBook) {
                <button (click)="close()" class="absolute top-5 right-5 text-white hover:text-red-400 text-xl transition-colors font-bold">x</button>
                <h2 class="text-xl font-semibold mb-4 text-white">Agregar nuevo libro</h2>
                <div class="flex flex-row items-center gap-1 inset-shadow-sm inset-shadow-zinc-800 w-full rounded-xl bg-zinc-700 p-3 outline-1 outline-zinc-600 text-white mb-1 focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out">
                    <img class="w-4 h-4" src="search.svg">
                    <input class="bg-transparent focus:outline-none w-full placeholder-white/70" placeholder="Busca cualquier libro de tu preferencia" [formControl]="searchControl" type="text">
                </div>
                <div class="mb-4">
                    <p (click)="createCustomBook = true" class="text-white font-light hover:underline cursor-pointer">No encuentras el libro que tu necesitas? Agregalo aqui!</p>
                </div>
                <div class="flex justify-center w-full">
                    <select [(ngModel)]="selectedLibrary" class="inset-shadow-sm inset-shadow-zinc-900 w-1/2 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white mb-4 focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out">
                        <option value="" selected disabled>Elige una biblioteca</option>
                        <option value="New library">Crear nueva biblioteca</option>
                        <option value="All">Todos</option>
                        @for (library of userLibraries; track $index) {
                            <option class="flex flex-row justify-evenly " [value]="library.name">{{ library.name }}</option>
                        }
                    </select>
                </div>
                @if (selectedLibrary === "New library") {
                    <form [formGroup]="libraryForm" class="flex flex-col items-center gap-4">
                        <div class="flex flex-col min-w-1/2 gap-4">
                            <fieldset>
                                <input formControlName="name" class="w-full bg-zinc-800 p-2 rounded-lg inset-shadow-sm inset-shadow-zinc-900 hover:inset-shadow-none hover:shadow-lg/20 hover:shadow-zinc-900 focus:outline-0 focus:shadow-zinc-900 focus:shadow-lg/20 focus-within:ring-2 focus-within:ring-amber-400 transition-all ease-out text-white" type="text" placeholder="Titulo">
                            </fieldset>
                            <fieldset>
                                <input formControlName="description" class="w-full min-h-30 bg-zinc-800 p-2 rounded-lg inset-shadow-sm inset-shadow-zinc-900 hover:inset-shadow-none hover:shadow-lg/20 hover:shadow-zinc-900 focus:outline-0 focus:shadow-zinc-900 focus:shadow-lg/20 focus-within:ring-2 focus-within:ring-amber-400 transition-all ease-out text-white" type="text" placeholder="Descripcion">
                            </fieldset>
                        </div>
                        <button [disabled]="libraryForm.invalid" (click)="createLibrary()" class="mt-1 bg-amber-500 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-amber-600 hover:shadow-lg/30 hover:-translate-y-1 transition-all ease-in-out">Crear biblioteca</button>
                    </form>
                } @else {
                    @if (searchResults.length) {
                        <ul class="bg-zinc-800 rounded-lg mt-2 max-h-60 overflow-y-auto" (scroll)="onScroll($event)">
                            @for (book of searchResults; track $index) {
                                <li (click)="addBookDb(book)" class="p-2 flex flex-row gap-2 hover:bg-zinc-600 transition-colors cursor-pointer">
                                    <img class="rounded-2xl" [src]="book.volumeInfo.imageLinks.smallThumbnail" [alt]="book.volumeInfo.title">
                                    <div class="flex flex-col w-4/5 gap-1 p-2">
                                        <p class="text-white text-center font-bold text-lg line-clamp-2">{{ book.volumeInfo.title }}</p>
                                        <p class="text-white text-center font-medium text-sm">{{ book.volumeInfo.authors?.join(', ') }}</p>
                                        <div class="flex flex-row gap-3">
                                            @for (categories of book.volumeInfo.categories; track $index) {
                                                <div class="rounded-4xl bg-zinc-700 text-white p-1 hover:shadow-lg/20 transition-shadow">
                                                    {{ categories }}
                                                </div>
                                            }
                                        </div>
                                        <p class="text-white text-md font-medium opacity-80 line-clamp-3 text-justify">{{ book.volumeInfo.description }}</p>
                                    </div>
                                </li>
                            }
                        </ul>
                    } @else {
                        <p class="text-white text-xl p-2">Ingresa el titulo de cualquier libro que quieras agregar a tu Book Tracker</p>
                    }
                }
            } @else {
                <form [formGroup]="bookForm" (ngSubmit)="onBookSubmit()" class="flex flex-col gap-2 h-[90vh] ocultar-scroll overflow-x-visible overflow-y-auto">
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white text-sm left-1">Titulo:</label>
                        <input formControlName="title" class="inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out" type="text" placeholder="Nombre del libro">
                        @if (fc('title').touched && fc('title').invalid) {
                            <p class="text-xs text-rose-400 mt-1">El titulo es requerido.</p>
                        }
                    </fieldset>
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white left-1">Autor(es):</label>
                        <input formControlName="authors" class="inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out" type="text" placeholder="Autor 1, Autor 2">
                    </fieldset>
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white left-1">Portada:</label>
                        <div class="flex gap-2 items-center mb-2">
                            <button class="hover:shadow-xl hover:shadow-zinc-800 transition-all ease-in" type="button" (click)="switchType('file')" [class]="coverMode === 'file' ? activeToggleClass : inactiveToggleClass">
                                Subir archivo
                            </button>
                            <button class="hover:shadow-xl hover:shadow-zinc-800 transition-all ease-in" type="button" (click)="switchType('url')" [class]="coverMode === 'url' ? activeToggleClass : inactiveToggleClass">
                                Usar URL
                            </button>
                        </div>
                    </fieldset>
                    @if (coverMode === 'file') {
                        <div class="flex items-center gap-3">
                            <label for="coverFile" class="cursor-pointer rounded-xl bg-zinc-600 p-3 text-white hover:bg-zinc-500 transition">
                                <input id="coverFile" type="file" name="book-covers" accept="image/*" (change)="onFileChange($event)" class="hidden" />
                                Seleccionar imagen
                            </label>
                            <span class="text-sm text-white/70">{{ selectedFileName || 'Ningún archivo seleccionado' }}</span>
                        </div>
                    } @else if (coverMode === 'url') {
                        <div>
                            <input formControlName="coverUrl" type="url" placeholder="https://ejemplo.com/portada.jpg" class="inset-shadow-sm w-full inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out"/>
                            @if (fc('coverUrl').touched && fc('coverUrl').invalid) {
                                <p class="text-xs text-rose-400 mt-1">Ingresa una URL válida.</p>
                            }
                        </div>
                    }
                    @if (previewImage) {
                        <div class="mt-3 flex flex-col justify-evenly items-center">
                            <p class="text-xl text-white/70 font-medium mb-2">Previsualización:</p>
                            <img [src]="previewImage" alt="Previsualización portada" class="w-38 h-46 object-cover rounded-md border" />
                        </div>
                    }
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white left-1">Descripcion:</label>
                        <textarea formControlName="description" class="inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out"></textarea>
                    </fieldset>
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white left-1">Categorias:</label>
                        <input formControlName="categories" class="inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out" type="text">
                    </fieldset>
                    <fieldset class="flex flex-col gap-1">
                        <label class="relative text-white left-1">Total de paginas:</label>
                        <input formControlName="pages" class="inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out" type="number">
                    </fieldset>
                    <fieldset class="flex flex-col gap-1 justify-center">
                        <p class="relative text-white left-1">Libreria:</p>
                        <select formControlName="customSelectedLibrary" class="w-full inset-shadow-sm inset-shadow-zinc-900 rounded-xl bg-zinc-800 p-3 outline-1 outline-zinc-700 text-white focus-within:ring-2 focus-within:ring-amber-400 hover:outline-amber-400 transition-all ease-out">
                            <option value="" selected disabled>Elige una biblioteca</option>
                            <option value="All">Todos</option>
                            @for (library of userLibraries; track $index) {
                                <option class="flex flex-row justify-evenly " [value]="library.name">{{ library.name }}</option>
                            }
                        </select>
                    </fieldset>
                    <div class="flex gap-3 justify-start mt-4">
                        <button type="button" (click)="createCustomBook = false" class="px-4 py-2 rounded-lg bg-zinc-600 text-white disabled:cursor-default cursor-pointer hover:bg-zinc-500">Cancelar</button>
                        <button type="submit" [disabled]="bookForm.invalid" 
                                class="px-4 py-2 rounded-lg bg-amber-600 text-white hover:bg-amber-700 disabled:opacity-60 disabled:cursor-default cursor-pointer">
                            Guardar libro
                        </button>
                    </div>
                </form>
            }
        </div> 
    </div>
}